<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:tx="http://www.springframework.org/schema/tx"
       xmlns:aop="http://www.springframework.org/schema/aop"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.0.xsd
       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.0.xsd">

    <bean id="dispatcher" class="org.firewaterframework.mappers.RouteMapper">
        <property name="urlMap" ref="urlMap"/>
    </bean>

    <bean id="urlMap" class="java.util.HashMap">
        <constructor-arg index="0">
            <map>
                <entry key="/photos" value-ref="photosMapper"/>
                <entry key="/owners/{ownerID}/photos" value-ref="photosMapper"/>
                <entry key="/photos/{photoID}" value-ref="photoMapper"/>
                <entry key="/owners" value-ref="ownersMapper"/>
                <entry key="/owners/{ownerID}" value-ref="ownerMapper"/>
            </map>
        </constructor-arg>
    </bean>

<!--
create table photo(id int auto_increment primary key, flickr_id int, link varchar(128), thumbnail varchar(128),
    owner_id int, title varchar(255));
create table owner(id int auto_increment primary key , flickr_id varchar(32), name varchar(64));
create table photo_tag(photo_id int, tag varchar(255));
-->

    <bean id="photosMapper" class="org.firewaterframework.mappers.MethodMapper">
        <property name="getMapper" ref="photosGetMapper"/>
        <property name="putMapper" ref="photosPutMapper"/>
    </bean>

    <bean id="photosGetMapper" class="org.firewaterframework.mappers.jdbc.QueryMapper">
        <property name="query">
            <value>
                select p.id as photo, p.thumbnail as thumbnail, p.title as title,
                    p.owner_id as owner, o.name as owner_name, pt.tag as tag, p.row_num
                from (
                    select id, thumbnail, title, owner_id, rownum() as row_num
                    from photo inner_p
                    $if(tags)$
                        join photo_tag inner_pt on inner_p.id = inner_pt.photo_id and
                            ($tags:{ inner_pt.tag = $it$ }; separator=" or "$)
                    $endif$
                    $if(ownerID)$
                        where inner_p.owner_id = $ownerID$
                    $endif$
                    $page_token$) as p
                left outer join owner o on o.id = p.owner_id
                left outer join photo_tag pt on pt.photo_id = p.id
                order by p.row_num, p.owner_id
            </value>
        </property>
        <property name="defaultPageSize" value="5"/>
        <property name="pageWindowSize" value="10"/>
        <property name="pageCountPivot" value="photo"/> 
        <property name="dataSource" ref="dataSource"/>
        <property name="fields">
            <map>
                <entry key="tags">
                    <bean class="org.firewaterframework.mappers.validation.SQLStringList"/>
                </entry>
                <entry key="ownerID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber"/>
                </entry>
            </map>
        </property>
        <property name="pivotTreeBuilder">
            <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                <property name="idColumn" value="photo"/>
                <property name="urlPrefix" value="photos"/>
                <property name="attributeColumnList">
                    <list>
                        <value>thumbnail</value>
                        <value>title</value>
                    </list>
                </property>
                <property name="subNodes">
                    <list>
                        <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                            <property name="idColumn" value="owner"/>
                            <property name="urlPrefix" value="owners"/>
                            <property name="subResource" value="false"/>
                            <property name="attributeColumnList">
                                <list>
                                    <value>owner_name</value>
                                </list>
                            </property>
                        </bean>
                        <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                            <property name="idColumn" value="tag"/>
                        </bean>
                    </list>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="photosPutMapper" class="org.firewaterframework.mappers.jdbc.UpdateMapper">
        <property name="queries">
            <list>
                <value>
                    insert into photo(link, thumbnail, owner_id, title)
                        values( $link$, $thumbnail$, $ownerID$,
                            $if(title)$
                                $title$
                            $else$
                                null
                            $endif$ )
                </value>
                <value>
                    $if(tags)$
                        insert into photo_tag( photo_id, tag ) values
                            $tags:{( $_keys.key_0$, $it$ ) };separator = ","$
                    $endif$
                </value>
            </list>
        </property>
        <property name="dataSource" ref="dataSource"/>
        <property name="fields">
            <map>
                <entry key="link">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral">
                        <property name="required" value="true"/>
                    </bean>
                </entry>
                <entry key="thumbnail">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral">
                        <property name="required" value="true"/>
                    </bean>
                </entry>
                <entry key="ownerID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber">
                        <property name="required" value="true"/>
                    </bean>
                </entry>
                <entry key="title">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral"/>
                </entry>
                <entry key="tags">
                    <bean class="org.firewaterframework.mappers.validation.SQLStringList"/>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="photoMapper" class="org.firewaterframework.mappers.MethodMapper">
        <property name="getMapper" ref="photoGetMapper"/>
        <property name="postMapper" ref="photoPostMapper"/>
        <property name="deleteMapper" ref="photoDeleteMapper"/>
    </bean>

    <bean id="photoGetMapper" class="org.firewaterframework.mappers.jdbc.QueryMapper">
        <property name="query">
            <value>
                select p.id as photo, p.thumbnail as thumbnail, p.link as link, p.title as title,
                    p.owner_id as owner, o.name as owner_name, pt.tag as tag
                from photo as p
                left outer join owner o on o.id = p.owner_id
                left outer join photo_tag pt on pt.photo_id = p.id
                where p.id = $photoID$
            </value>
        </property>
        <property name="dataSource" ref="dataSource"/>
        <property name="pivotTreeBuilder">
            <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                <property name="idColumn" value="photo"/>
                <property name="urlPrefix" value="photos"/>
                <property name="attributeColumnList">
                    <list>
                        <value>thumbnail</value>
                        <value>title</value>
                        <value>link</value>
                    </list>
                </property>
                <property name="subNodes">
                    <list>
                        <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                            <property name="idColumn" value="owner"/>
                            <property name="urlPrefix" value="owners"/>
                            <property name="attributeColumnList">
                                <list>
                                    <value>owner_name</value>
                                </list>
                            </property>
                        </bean>
                        <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                            <property name="idColumn" value="tag"/>
                        </bean>
                    </list>
                </property>
            </bean>
        </property>
    </bean>

    <bean id="photoPostMapper" class="org.firewaterframework.mappers.jdbc.UpdateMapper">
        <property name="queries">
            <list>
                <value>
                    update photo set id = $photoID$
                        $if(thumbnail)$
                            , thumbnail = $thumbnail$
                        $endif$
                        $if(link)$
                            , link = $link$
                        $endif$
                        $if(title)$
                            , title = $title$
                        $endif$
                        where id = $photoID$
                </value>
            </list>
        </property>
        <property name="dataSource" ref="dataSource"/>
        <property name="fields">
            <map>
                <entry key="link">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral">
                        <property name="required" value="true"/>
                    </bean>
                </entry>
                <entry key="thumbnail">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral">
                        <property name="required" value="true"/>
                    </bean>
                </entry>
                <entry key="title">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral"/>
                </entry>
                <entry key="photoID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber"/>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="photoDeleteMapper" class="org.firewaterframework.mappers.jdbc.UpdateMapper">
        <property name="dataSource" ref="dataSource"/>
        <property name="queries">
            <list>
                <value>
                    delete from photo where id = $photoID$
                </value>
            </list>
        </property>
        <property name="fields">
            <map>
                <entry key="photoID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber"/>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="ownersMapper" class="org.firewaterframework.mappers.MethodMapper">
        <property name="getMapper" ref="ownersGetMapper"/>
        <property name="putMapper" ref="ownersPutMapper"/>
    </bean>

    <bean id="ownersGetMapper" class="org.firewaterframework.mappers.jdbc.QueryMapper">
        <property name="dataSource" ref="dataSource"/>
        <property name="defaultPageSize" value="20"/>
        <property name="pageWindowSize" value="10"/>
        <property name="query" value="select id as owner, name from owner $page_token$"/>
        <property name="pivotTreeBuilder">
            <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                <property name="idColumn" value="owner"/>
                <property name="attributeColumnList">
                    <list>
                        <value>name</value>
                    </list>
                </property>
                <property name="tagname" value="owners"/>
            </bean>
        </property>
    </bean>

    <bean id="ownersPutMapper" class="org.firewaterframework.mappers.jdbc.UpdateMapper">
        <property name="dataSource" ref="dataSource"/>
        <property name="queries">
            <list>
                <value>
                    insert into owner( flickr_id, name ) values
                    (
                        $if(flickr_id)$
                            $flickr_id$
                        $else$
                            null
                        $endif$, $name$ )
                </value>
            </list>
        </property>
        <property name="fields">
            <map>
                <entry key="flickr_id">
                    <bean class="org.firewaterframework.mappers.validation.SQLLiteral"/>
                </entry>
                <entry key="name">
                    <bean class="org.firewaterframework.mappers.validation.SQLString"/>
                </entry>
            </map>
        </property>
    </bean>
    
    <bean id="ownerMapper" class="org.firewaterframework.mappers.MethodMapper">
        <property name="getMapper" ref="ownerGetMapper"/>
        <property name="postMapper" ref="ownerPostMapper"/>
        <property name="deleteMapper" ref="ownerDeleteMapper"/>
    </bean>

    <bean id="ownerGetMapper" class="org.firewaterframework.mappers.jdbc.QueryMapper">
        <property name="dataSource" ref="dataSource"/>
        <property name="query">
            <value>
                select id as owner, name, flickr_id from owner where id = $ownerID$
            </value>
        </property>
        <property name="pivotTreeBuilder">
            <bean class="org.firewaterframework.mappers.jdbc.PivotTreeBuilder">
                <property name="idColumn" value="owner"/>
                <property name="attributeColumnList">
                    <list>
                        <value>name</value>
                        <value>flickr_id</value>
                    </list>
                </property>
            </bean>
        </property>
        <property name="fields">
            <map>
                <entry key="ownerID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber"/>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="ownerPostMapper" class="org.firewaterframework.mappers.jdbc.UpdateMapper">
        <property name="dataSource" ref="dataSource"/>
        <property name="queries">
            <list>
                <value>
                    update owner set id = $ownerID$
                        $if(flickr_id)$
                            , flickr_id = $flickr_id$
                        $endif$
                        $if(name)$
                            , name = $name$
                        $endif$
                    where id = $ownerID$
                </value>
            </list>
        </property>
        <property name="fields">
            <map>
                <entry key="ownerID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber"/>
                </entry>
                <entry key="flickr_id">
                    <bean class="org.firewaterframework.mappers.validation.SQLString"/>
                </entry>
                <entry key="name">
                    <bean class="org.firewaterframework.mappers.validation.SQLString"/>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="ownerDeleteMapper" class="org.firewaterframework.mappers.jdbc.UpdateMapper">
        <property name="dataSource" ref="dataSource"/>
        <property name="queries">
            <list>
                <value>
                    delete from owner where id = $ownerID$
                </value>
                <value>
                    delete from photo_tag where photo_id = (select id from photo where owner_id = $ownerID$)
                </value>
                <value>
                    delete from photo where owner_id = $ownerID$
                </value>
            </list>
        </property>
        <property name="fields">
            <map>
                <entry key="ownerID">
                    <bean class="org.firewaterframework.mappers.validation.SQLNumber"/>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="dataSource" destroy-method="close" class="org.apache.commons.dbcp.BasicDataSource">
        <property name="driverClassName" value="org.h2.Driver"/>
        <property name="url" value="jdbc:h2:mem:test"/>
    </bean>

    <bean id="executedSQL" class="org.firewaterframework.util.DatabaseUtil" factory-method="loadSQL" depends-on="dataSource">
        <constructor-arg index="0" value="/WEB-INF/classes/flickrSampleData.sql"/>
        <constructor-arg index="1" ref="dataSource"/>
    </bean>

    <tx:annotation-driven/>

    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
</beans>
<!--
Copyright 2008 John TW Spurway
Licensed under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with the License.
You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software distributed under the
License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
either express or implied. See the License for the specific language governing permissions
and limitations under the License. -->